# 要件定義書兼機能設計書

## 1. 概要

日本拳法の試合における得点や反則、試合時間をリアルタイムで表示・管理するためのWebアプリケーション。  
Presentation APIを利用して、操作画面とは別のモニターに得点板を全画面表示することを目的とする。

## 2. システム構成

- **フロントエンド**: React, Next.js
- **データベース**: Firebase (Firestore)
- **認証**: Firebase Authentication
- **リアルタイム連携**: Firestore Realtime Listeners
- **外部モニター表示**: Presentation API
## 3. データ定義

各試合で表示・管理するデータは以下の通り。

### 選手A/選手B

- **所属名**: チーム名
- **選手名**: 姓のみ
- **得点**: 0, 1, 2 のいずれか。2点先取で試合終了。
- **反則**: 無し → 黄 → 赤 → 赤+黄 → 赤+赤 の5段階

### 反則と得点の自動連動ロジック

- 反則状態が `赤` になった瞬間に、相手選手の得点が自動で +1 される
- 同様に、`赤` or `赤+黄` → `赤+赤` へ状態が変更された際も、相手選手の得点が自動で +1 される
- 逆に、反則状態が戻された場合（例: `赤` → `黒`）は、相手選手の得点が自動で -1 される
- `赤+赤` の状態になると合計で相手に2点が加算され、ルール上試合終了となる

### その他の情報

- **大会名**
- **コート名**
- **何試合目か**
- **試合時間**: カウントダウン形式のタイマー
## 4. 画面構成

アスタリスク(*)が付いている画面は、認証なしでアクセス可能。  
階層になっているのは、その画面から遷移できることを示している。  
試合一覧画面、試合の組み合わせ設定画面、チーム・選手管理画面はタブで切り替え。  
画面上部にヘッダーを配置。

### 画面一覧

- ログイン画面
  - パスワード再設定画面
- 試合一覧画面
  - モニター操作画面
    - 表示用モニター画面
- 試合の組み合わせ設定画面
- チーム・選手管理画面
  - 登録内容編集画面
- 大会設定画面
- *選手登録フォーム画面
- *選手登録完了画面

### ヘッダー

- ヘッダーにタブを配置
- 右端に歯車ボタンを配置
  - 大会設定画面へ遷移ボタン
  - ログアウトボタン
- 歯車ボタンの左に大会名を表示
- 左上にロゴを配置（タップで試合一覧画面へ遷移）

## 5. 各画面機能詳細

### ログイン画面

- メールアドレスとパスワードでログイン認証を行う
- パスワード再設定画面へのリンクを設置する

### パスワード再設定画面

- 登録済みのメールアドレスを入力し、パスワード再設定用のメールを送信する
- 送信後、「（入力したメールアドレス）に再設定メールを送信しました。」というメッセージを表示する

### 試合一覧画面

- 画面上部に大会名を表示する
- 各試合の情報をテーブル形式で表示する

#### 表示項目
コート名｜回戦｜選手A所属｜選手A名｜選手B所属｜選手B名｜得点｜操作画面への遷移ボタン

#### 勝敗表示
- 試合の得点に応じて、選手名と所属名の文字色を変更する
  - **勝利している選手**: 青色
  - **引き分け**: 両選手とも水色
### モニター操作画面

試合一覧画面から遷移し、Presentation APIで接続された別モニターの表示を操作する。

#### データフローと状態管理

##### 初期データの取得
試合一覧画面から以下のデータを受け取り初期表示する:
- 試合id
- 選手情報
- 得点
- 反則
- 大会・コート・回戦

##### ローカル状態での管理
- 読み込んだ初期データ、および「タイマー」「公開/非公開」の状態は、すべてモニター操作画面コンポーネントのローカル状態で管理する
- 試合中のすべての操作（得点、反則、タイマー開始/停止）は、Firestoreには書き込まず、このローカル状態のみを更新する

##### 表示用モニターへのリアルタイム連携
- 表示用モニター画面（Presentation APIで開いた別ウィンドウ）とは、APIの通信機能（postMessageなど）で直接接続する
- ローカル状態（得点、タイマーなど）が変更されるたびに、即座に最新の状態データを表示用モニター画面に送信し、表示をリアルタイムで更新させる

#### 表示・操作項目

- **選手情報 (A/B)**: 所属名、選手名を表示
- **得点**: (0, 1, 2) のボタンでローカル状態を変更可能
- **反則**: 5種類の状態（無し、黄、赤、赤+黄、赤+赤）をタップしてローカル状態を変更する。状態変更に伴う相手の得点増減ロジックもローカルで処理する
- **試合時間**: ドラムロールUIでローカル状態のタイマー値を設定可能（停止中のみ）
- **タイマー状態**: 「動作中」「停止中」ボタンでローカル状態を操作する。ローカルのタイマーが0秒になると自動で「停止中」になる
- **表示切替**: 「公開」「非公開」トグルスイッチでローカル状態を制御する

#### 保存処理

**試合結果保存ボタン**: このボタンを押すことで、その時点での**ローカル状態（最終的な得点、反則）**がFirebaseのmatchesドキュメントに書き込まれ、試合一覧画面に反映される。
### 表示用モニター画面

- Presentation APIを使用し、PCに接続された別モニターに全画面表示する
- モニター操作画面のローカル状態から直接送信されるデータ（得点、反則、タイマー、公開状態）を、Presentation APIの通信機能（onmessageなど）を介してリアルタイムで受信し、画面に反映する
- この画面自体はFirestoreを購読せず、計算ロジックも持たず、データの表示に徹する
- モニター操作画面から送られてきた状態が「非公開」の場合、「準備中」などのメッセージを表示する

### 大会設定画面

- 大会情報を設定する画面
- 遷移前画面からtournamentsのデータを全て受け取る。その情報を元に初期データを表示

#### 変更可能な情報
- **大会名**: テキストフィールド
- **開催日**: テキストフィールド
- **開催場所**: テキストフィールド
- **デフォルト試合時間**: ドラムロールUI。表示は「59:59」形式だが、保存時は秒に換算
- **会場のコート情報**: テキストフィールドをリストで表示。追加・削除可能

### *選手登録フォーム画面

- 認証不要で誰でもアクセス可能な選手登録ページ
- ページを離れようとした場合（戻るボタン、リロードなど）、「入力内容が破棄されますがよろしいですか？」といった確認ダイアログを表示する

#### 入力フォーム
- **代表者名**
- **代表者電話番号**
- **代表者メールアドレス**
- **チーム名（所属名）**
- **参加選手名**
  - 姓と名の間に半角スペースを入力。そのため、テキストフィールドは1つのみ
  - 「選手を追加」ボタンで入力欄を増やせる
- **備考欄（自由入力）**

※備考欄以外必須項目

#### 確認機能
- 画面下部に「内容を確認」ボタンを配置
- 押すと、選手登録確認ダイアログが表示される
- 必須項目が入力されていなければ、項目下に赤色でエラー表示して、ダイアログは表示しない

### *選手登録確認ダイアログ

- 入力された内容を表示して確認させる
- 参加選手名は、姓と名を分けて表示する
- 画面下部に「送信」ボタンを配置
- ボタンを押すと、fireStoreの'teams'に保存される（その際、displayNameは空欄で良い）
- 正常に保存出来れば、登録完了画面へ遷移する


### *選手登録完了画面

- 選手登録フォームの送信後に表示されるページ
- 「登録申請が完了しました。入力内容をメールに送信しましたのでご確認ください。」といったメッセージを表示する
- 登録完了メールを送信する

### メール機能

#### 使用技術
- Firebase Cloud Function
- SendGrid

#### 実装詳細
- Firestoreのteamsコレクションに新しいドキュメントが追加されたことをトリガーとする
- SendGridを用いて、以下の内容のメールを送信する:

##### メール内容
- 「このメールは送信専用です」の趣旨
- 「以下の内容で登録申請が完了しました」の趣旨

##### 登録内容
- 代表者名
- 代表者電話番号
- 代表者メールアドレス
- チーム名（所属名）
- 参加選手名
- 備考欄

- 「変更やご不明点は運営担当者 〇〇 fugafuga@example.com 宛にお願い致します。」
### 試合の組み合わせ設定画面

- 承認済みの選手情報から、試合の組み合わせを設定する
- 設定した内容はFirestoreの`matches`に保存する

#### UI
表形式で以下の項目を入力・選択する（Excelのような見た目を想定）:  
コート名｜回戦｜選手A所属｜選手A表示名｜選手B所属｜選手B表示名

#### 選手選択
- **所属**: 承認済みのチームをドロップダウンリストから選択する
- **選手名**: 所属が選択された後、その所属の選手がドロップダウンリストに表示される
- 所属を選択せずに選手名を選択しようとすると、「所属を先に選択してください」というトースト通知を表示する

#### その他機能
- 設定した組み合わせの編集および削除もこの画面で行える
### チーム・選手管理画面

選手登録フォームから送信された申請内容を一覧で確認し、承認・管理する画面。

#### 表示形式
- 各申請をカード形式で一覧表示する
- **カード内情報**: 代表者名、電話番号、メールアドレス、所属名、選手数、承認状態
- カード内の選手数表示（例: 「選手数: 16人」）をタップすると、選手一覧が展開表示される

#### 操作

##### 承認状態の切替
- **非承認の場合**: 「承認」ボタンを表示。承認されると、displayNameを作成する関数を実行する
- **承認済みの場合**: 「承認前に戻す」ボタンを表示
- 各ボタンをタップすると確認ダイアログが表示され、「OK」を押すと状態が変更される（承認状態はDB上でtrue/falseのフラグで管理）

##### 編集
- 「編集」ボタンを押し、登録内容編集画面へ遷移する
### 登録内容編集画面

申請内容の詳細を編集する。

#### UI
- 承認状態、代表者名、電話番号、メールアドレス、所属名、選手名リスト（姓名を分けて姓名を横に並べ、1人1行で表示）が全てテキストフィールドで表示され、編集可能

#### 操作
- ヘッダーに「戻る」ボタンと「保存」ボタンを配置する
- フォーム内容が変更された状態でページを離れようとした場合（戻るボタン、リロードなど）、「編集内容が破棄されますがよろしいですか？」といった確認ダイアログを表示する

### 保存時の処理 (Cloud Functionトリガー)

「保存」ボタンが押され、`teams`ドキュメントの`players`配列または`teamName`が変更された場合、onUpdateトリガーで以下のCloud Functionが実行される:

1. **displayNameの再計算**: 下記の「displayNameの作成方法」ロジックに基づき、チーム全員の`displayName`を再計算・保存する
2. **matchesの同期**: 変更された選手の`playerId`や`teamId`を使って`matches`コレクションを検索し、`playerA`または`playerB`に含まれる`displayName`や`teamName`を最新の情報に書き換える

### displayNameの作成方法 (Cloud Functionロジック)

Cloud Functionは、チームのplayers配列全体をチェックし、以下のロジックで全選手のdisplayNameを決定する:

1. まず、全選手のdisplayNameを「姓」で初期設定する
2. 次に、チーム内で「姓」が重複している選手グループを探す
3. 重複グループが見つかった場合、そのグループの選手全員のdisplayNameを「姓 + 半角スペース + 名の一部」に変更する

#### 例
- 山田 太郎、鈴木 一郎 → displayNameは「山田」「鈴木」
- 山田 太郎、山田 健太、鈴木 一郎 → displayNameは「山田 太」「山田 健」「鈴木」
- 山田 太郎、山田 健太、山田 太一 → displayNameは「山田 太郎」「山田 健」「山田太一」
## 6. 横断的要件

### 権限管理
- ユーザーロール（役割）による権限分離は行わない
- １つの管理者アカウントを共有し、各コートに設置した端末で同じアカウントを使用して操作する

### エラーハンドリング
- 通信失敗時や不正な操作が行われた場合は、画面下部などにトースト通知を表示してユーザーに状態を伝える

### その他
- 選手をリストで表示する場合は、昇順で表示する

